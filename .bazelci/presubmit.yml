# Copyright 2023 The Bazel Authors. All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
buildifier:
  # keep these arguments in sync with .pre-commit-config.yaml
  # Use a specific version to avoid skew issues when new versions are released.
  version: 8.2.1
  warnings: "all"
# NOTE: Minimum supported version is 7.x
.minimum_supported_version: &minimum_supported_version
  # For testing minimum supported version.
  # NOTE: Keep in sync with //:version.bzl
  bazel: 7.x
  skip_in_bazel_downstream_pipeline: "Bazel 7 required"
.reusable_config: &reusable_config
  build_targets:
    - "--"
    - "..."
    # As a regression test for #225, check that wheel targets still build when
    # their package path is qualified with the repo name.
    - "@rules_python//examples/wheel/..."
  build_flags:
    - "--keep_going"
    - "--build_tag_filters=-integration-test"
  test_targets:
    - "--"
    - "..."
  test_flags:
    - "--test_tag_filters=-integration-test"
.common_workspace_flags_min_bazel: &common_workspace_flags_min_bazel
  build_flags:
    - "--noenable_bzlmod"
    - "--build_tag_filters=-integration-test"
  test_flags:
    - "--noenable_bzlmod"
    - "--test_tag_filters=-integration-test"
.common_workspace_flags: &common_workspace_flags
  skip_in_bazel_downstream_pipeline: "Bazel 9 doesn't support workspace"
  test_flags:
    - "--noenable_bzlmod"
    - "--enable_workspace"
    - "--test_tag_filters=-integration-test"
  build_flags:
    - "--noenable_bzlmod"
    - "--enable_workspace"
    - "--build_tag_filters=-integration-test"
  bazel: 7.x
# NOTE: The Mac and Windows bazelinbazel jobs override parts of this config.
.common_bazelinbazel_config: &common_bazelinbazel_config
    build_flags:
      - "--build_tag_filters=integration-test"
    test_flags:
      - "--test_tag_filters=integration-test"
      - "--jobs=2"
      # The integration tests are so expensive that only a few can be run concurrently
      # without harming overall reliability and runtime.
      - "--local_test_jobs=2"
    build_targets: ["..."]
    test_targets: ["..."]

.reusable_build_test_all: &reusable_build_test_all
  build_targets: ["..."]
  test_targets: ["..."]
.coverage_targets_example_bzlmod: &coverage_targets_example_bzlmod
  coverage_targets: ["..."]
.coverage_targets_example_bzlmod_build_file_generation: &coverage_targets_example_bzlmod_build_file_generation
  coverage_targets: ["//:bzlmod_build_file_generation_test"]
.coverage_targets_example_multi_python: &coverage_targets_example_multi_python
  coverage_targets:
    - //tests:my_lib_3_10_test
    - //tests:my_lib_3_11_test
    - //tests:my_lib_3_9_test
    - //tests:my_lib_default_test
    - //tests:version_3_10_test
    - //tests:version_3_11_test
    - //tests:version_3_9_test
    - //tests:version_default_test

matrix:
  platform:
    - windows
  #bazel: [7.*, 8.*]
  bazel: [8.0.0, 8.1.0, 8.2.0, 8.3.0, 8.4.0]
tasks:
  # Keep in sync with .bcr/presubmit.yml
  bcr_tests:
    name: BCR test module
    platform: ${{ platform }}
    bazel: ${{ bazel }}
    working_directory: examples/bzlmod
    platform: ${{ platform }}
    bazel: ${{ bazel }}
    ##shell_commands:
    ##  - "bazel vendor --vendor_dir=./vendor //..."
    ##  - "bazel build --vendor_dir=./vendor //..."
    ##  - "rm -rf ./vendor"
    ##coverage_targets: ["//:test"]
    test_flags:
      - "--keep_going"
        # Without these cxxopts, BCR's Mac builds fail
      - '--cxxopt=-std=c++14'
      - '--host_cxxopt=-std=c++14'
      - '--test_output=streamed'
    test_targets:
      #- "//tests/..."
      - "//tests:version_test_binary_3_10"
